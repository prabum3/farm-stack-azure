name: build and deploy
on:
  workflow_dispatch:
  # push:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Azure login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login into container registry
      run: |
        az acr login --name ${{ secrets.AZURE_CONTAINER_REGISTRY }}

    - name: Build React App
      run: |
        cd ./client
        npm install
        npm run build

    - name: Build and push docker image (nginx-reverse-proxy)
      run: |
        cd ./nginx/production
        IMAGE_NAME=${{ secrets.AZURE_CONTAINER_REGISTRY }}/${{ secrets.WEB_APP_NAME }}-nginx-react-image:latest
        echo "building image $IMAGE_NAME"
        docker image build -t $IMAGE_NAME .
        docker push $IMAGE_NAME

    - name: Build and push docker image (fastapi)
      run: |
        cd ./server
        IMAGE_NAME=${{ secrets.AZURE_CONTAINER_REGISTRY }}/${{ secrets.WEB_APP_NAME }}-fastapi-image:latest
        echo "building image $IMAGE_NAME"
        docker image build -t $IMAGE_NAME .
        docker push $IMAGE_NAME

    - name: Deploy with docker-compose
      run: |
        az webapp config container set --resource-group ${{ secrets.RESOURCE_GROUP_NAME }} --name ${{ secrets.WEB_APP_NAME }} --multicontainer-config-type compose --multicontainer-config-file docker-compose.yml

    - name: Set connection string
      run: |
        az webapp config appsettings set -g ${{ secrets.RESOURCE_GROUP_NAME }} -n ${{ secrets.WEB_APP_NAME }} --settings MONGODB_URL="${{ secrets.MONGODB_URL }}"




